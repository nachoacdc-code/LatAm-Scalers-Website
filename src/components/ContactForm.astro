---
export type Props = {
	action?: string;
	redirectTo?: string;
	subject?: string;
	role?: string;
	defaultCategory?: 'aec' | 'design' | 'marketing' | '';
	/** @deprecated use defaultCategory instead */
	defaultInterest?: string;
	defaultMessage?: string;
};

const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xzdakggg';
const action =
	Astro.props.action ??
	import.meta.env.PUBLIC_FORMSPREE_ACTION ??
	FORMSPREE_ENDPOINT;

const redirectTo = Astro.props.redirectTo ?? '';
const subject = Astro.props.subject ?? 'LatAm Scalers — new inquiry';
const role = Astro.props.role ?? '';
const defaultMessage = Astro.props.defaultMessage ?? '';
const defaultCategory = (Astro.props.defaultCategory ?? Astro.props.defaultInterest ?? '') as 'aec' | 'design' | 'marketing' | '';

const formId = `cf-${Math.random().toString(36).slice(2, 9)}`;
---

<form
	id={formId}
	action={action || undefined}
	method="POST"
	class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6"
	aria-label="Contact form"
	novalidate
	data-contact-form
	data-fallback-subject={subject}
>
	<p class="mb-5 text-xs text-slate-500">
		All fields marked <span class="text-rose-400">*</span> are required.
	</p>

	<div class="grid gap-4 sm:grid-cols-2">

		<!-- Progressive commitment: low-friction first, high-value qualifying early -->
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-name`}>
				Full name <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-name`}
				name="name"
				autocomplete="name"
				required
				aria-required="true"
			/>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-email`}>
				Work email <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-email`}
				name="email"
				type="email"
				autocomplete="email"
				inputmode="email"
				required
				aria-required="true"
				data-work-email
			/>
			<p class="mt-1 hidden text-xs text-rose-400" data-email-error aria-live="polite">
				Please use your work email (no Gmail, Yahoo, Hotmail, etc.)
			</p>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-company`}>
				Company <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-company`}
				name="company"
				autocomplete="organization"
				required
				aria-required="true"
			/>
		</div>

		<div class="sm:col-span-2">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-message`}>
				What do you need help with? <span class="text-rose-400">*</span>
			</label>
			<textarea
				class="mt-2 min-h-24 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-message`}
				name="message"
				placeholder="Describe the role, tools, and what success looks like for you."
				required
				aria-required="true"
			>{defaultMessage}</textarea>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-company-size`}>
				Company size <span class="text-rose-400">*</span>
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-company-size`}
				name="company_size"
				required
				aria-required="true"
			>
				<option value="" selected disabled>Select…</option>
				<option value="1-25">1–25 employees</option>
				<option value="25-50">25–50 employees</option>
				<option value="50-100">50–100 employees</option>
				<option value="100-200">100–200 employees</option>
				<option value="200+">200+ employees</option>
			</select>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-position`}>
				Your role / position <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-position`}
				name="position"
				autocomplete="organization-title"
				placeholder="e.g. VP of Engineering, Design Director"
				required
				aria-required="true"
			/>
		</div>

		<div class="sm:col-span-2">
			<label class="flex cursor-pointer items-start gap-3">
				<input
					type="checkbox"
					name="is_hiring_company"
					value="yes"
					class="mt-0.5 h-4 w-4 shrink-0 rounded border-slate-700 bg-slate-950/60 text-sky-600 focus:ring-sky-300 focus:ring-offset-slate-950"
					required
					aria-required="true"
				/>
				<span class="text-sm text-slate-300">
					I'm a company looking to hire dedicated LATAM talent. <span class="text-rose-400">*</span>
				</span>
			</label>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-phone`}>
				Phone number
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-phone`}
				name="phone"
				type="tel"
				inputmode="tel"
				autocomplete="tel"
				placeholder="+1 (555) 000-0000"
			/>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-website-url`}>
				Company website
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-website-url`}
				name="company_website"
				type="text"
				inputmode="url"
				autocomplete="url"
				placeholder="yourcompany.com"
				data-company-website
			/>
			<p class="mt-1 hidden text-xs text-rose-400" data-website-error aria-live="polite">
				Please enter a valid website (e.g. yourcompany.com)
			</p>
		</div>

		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-source`}>
				How did you hear about us?
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-source`}
				name="attribution_source"
			>
				<option value="" selected>Select…</option>
				<option value="google">Google Search</option>
				<option value="linkedin">LinkedIn</option>
				<option value="ai-llm">AI Assistant (ChatGPT, Claude, Gemini…)</option>
				<option value="referral">Referral</option>
				<option value="industry-event">Industry Event</option>
				<option value="other">Other</option>
			</select>
		</div>

		{/* Expandable optional fields — progressive disclosure */}
		<div class="sm:col-span-2">
			<button
				type="button"
				class="flex items-center gap-2 text-sm font-medium text-sky-400 transition hover:text-sky-300"
				data-toggle-optional
				aria-expanded="false"
			>
				<svg class="h-4 w-4 transition-transform" data-chevron viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
				Help us qualify your needs (optional)
			</button>

			<div class="mt-3 hidden grid gap-4 sm:grid-cols-2" data-optional-fields>
				<div class="sm:col-span-1">
					<label class="text-sm font-medium text-slate-200" for={`${formId}-category`}>What do you need?</label>
					<select
						class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						id={`${formId}-category`}
						name="category"
					>
						<option value="not-specified" selected={!defaultCategory}>Skip / Not sure</option>
						<option value="aec" selected={defaultCategory === 'aec'}>AEC (BIM, CAD, Engineering)</option>
						<option value="design" selected={defaultCategory === 'design'}>Creative & Design</option>
						<option value="marketing" selected={defaultCategory === 'marketing'}>Marketing</option>
						<option value="multiple">Multiple categories</option>
					</select>
				</div>
				<div class="sm:col-span-1">
					<label class="text-sm font-medium text-slate-200" for={`${formId}-timeline`}>Timeline</label>
					<select
						class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						id={`${formId}-timeline`}
						name="timeline"
					>
						<option value="flexible" selected>Skip / Flexible</option>
						<option value="asap">ASAP</option>
						<option value="1-2-weeks">1–2 weeks</option>
						<option value="2-4-weeks">2–4 weeks</option>
					</select>
				</div>
				<div class="sm:col-span-2">
					<label class="text-sm font-medium text-slate-200" for={`${formId}-budget`}>Monthly budget</label>
					<select
						class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						id={`${formId}-budget`}
						name="budget_range"
					>
						<option value="not-specified" selected>Skip / Not sure yet</option>
						<option value="under-2500">Under $2,500/mo</option>
						<option value="2500-5000">$2,500–$5,000/mo</option>
						<option value="5000-10000">$5,000–$10,000/mo</option>
						<option value="10000+">$10,000+/mo</option>
					</select>
				</div>
			</div>
		</div>
	</div>

	<div aria-hidden="true" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;">
		<label for={`${formId}-website`}>Website</label>
		<input id={`${formId}-website`} name="website" tabindex="-1" autocomplete="off" />
		<input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
	</div>

	<input type="hidden" name="_subject" value="" data-subject />
	<input type="hidden" name="source_page" value="" data-source-page />
	<input type="hidden" name="submission_url" value="" data-submission-url />
	<input type="hidden" name="submission_location" value="" data-submission-location />
	{redirectTo ? <input type="hidden" name="_redirect" value={redirectTo} /> : null}
	{role ? <input type="hidden" name="role" value={role} /> : null}
	<input type="hidden" name="g-recaptcha-response" data-recaptcha-token />

	<div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
		<button
			type="submit"
			class="inline-flex min-h-[44px] items-center justify-center rounded-xl bg-sky-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 disabled:opacity-60"
			data-submit-btn
		>
			Get my vetted shortlist
		</button>
		<p class="text-xs text-slate-500" data-form-note aria-live="polite"></p>
	</div>
</form>

<script is:inline>
(function () {
  // Progressive disclosure: toggle optional fields
  document.querySelectorAll('[data-toggle-optional]').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var panel = btn.closest('.sm\\:col-span-2, [class*="col-span"]')?.querySelector('[data-optional-fields]');
      if (!panel) panel = btn.parentElement?.querySelector('[data-optional-fields]');
      if (!panel) return;
      var isHidden = panel.classList.contains('hidden');
      panel.classList.toggle('hidden', !isHidden);
      btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      var chevron = btn.querySelector('[data-chevron]');
      if (chevron) chevron.style.transform = isHidden ? 'rotate(180deg)' : '';
    });
  });

  const FREE_DOMAINS = new Set([
    'gmail.com','yahoo.com','hotmail.com','outlook.com','live.com',
    'icloud.com','me.com','aol.com','msn.com','protonmail.com',
    'ymail.com','mail.com','zoho.com','inbox.com','gmx.com',
  ]);

  function getSourcePageLabel() {
    var path = (window.location.pathname || '/').replace(/\/$/, '') || '/';
    var map = {
      '/': 'Homepage',
      '/aec': 'AEC',
      '/design': 'Design',
      '/marketing': 'Marketing',
      '/get-started': 'Get Started',
      '/how-it-works': 'How it works',
      '/how-pricing-works': 'Pricing',
      '/about/how-we-vet': 'About',
      '/about/our-guarantee': 'About',
    };
    if (map[path]) return map[path];
    if (path.startsWith('/aec/')) return 'AEC – ' + path.replace('/aec/', '').replace(/-/g, ' ');
    if (path.startsWith('/design/')) return 'Design – ' + path.replace('/design/', '').replace(/-/g, ' ');
    if (path.startsWith('/marketing/')) return 'Marketing – ' + path.replace('/marketing/', '').replace(/-/g, ' ');
    if (path.startsWith('/roles/')) return 'Role – ' + path.replace('/roles/', '').replace(/-/g, ' ');
    return path || 'Unknown';
  }

  function normalizeCompanyWebsite(input) {
    var s = (input || '').trim().toLowerCase();
    if (!s) return '';
    s = s.replace(/^(https?:\/\/)?(www\.)?/, '');
    s = s.replace(/\/.*$/, '');
    if (!s) return '';
    return 'https://' + s;
  }

  function isValidDomain(input) {
    var s = (input || '').trim();
    if (!s || s.length < 4) return false;
    var domain = s.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0].split('?')[0];
    return domain.length >= 4 && domain.indexOf('.') > 0 && /^[a-z0-9][a-z0-9.-]*\.[a-z0-9][a-z0-9.-]+$/i.test(domain);
  }

  document.querySelectorAll('[data-contact-form]').forEach(function (form) {
    var emailInput = form.querySelector('[data-work-email]');
    var emailError = form.querySelector('[data-email-error]');
    var websiteInput = form.querySelector('[data-company-website]');
    var websiteError = form.querySelector('[data-website-error]');
    var submitBtn  = form.querySelector('[data-submit-btn]');
    var formNote   = form.querySelector('[data-form-note]');
    var recaptchaToken = form.querySelector('[data-recaptcha-token]');
    var sourcePageInput = form.querySelector('[data-source-page]');
    var subjectInput = form.querySelector('[data-subject]');
    var submissionUrlInput = form.querySelector('[data-submission-url]');
    var submissionLocationInput = form.querySelector('[data-submission-location]');
    var hiringCheckbox = form.querySelector('[name="is_hiring_company"]');

    if (hiringCheckbox) {
      hiringCheckbox.setCustomValidity('Please confirm you\'re a company looking to hire LATAM talent.');
      hiringCheckbox.addEventListener('change', function () {
        hiringCheckbox.setCustomValidity(hiringCheckbox.checked ? '' : 'Please confirm you\'re a company looking to hire LATAM talent.');
      });
    }

    function isFreeDomain(email) {
      var parts = (email || '').split('@');
      return parts.length === 2 && FREE_DOMAINS.has(parts[1].toLowerCase().trim());
    }

    if (emailInput && emailError) {
      emailInput.addEventListener('blur', function () {
        if (isFreeDomain(emailInput.value)) {
          emailError.classList.remove('hidden');
          emailInput.setAttribute('aria-invalid', 'true');
        } else {
          emailError.classList.add('hidden');
          emailInput.removeAttribute('aria-invalid');
        }
      });
    }

    if (websiteInput && websiteError) {
      websiteInput.addEventListener('blur', function () {
        if (websiteInput.value.trim() && !isValidDomain(websiteInput.value)) {
          websiteError.classList.remove('hidden');
          websiteInput.setAttribute('aria-invalid', 'true');
        } else {
          websiteError.classList.add('hidden');
          websiteInput.removeAttribute('aria-invalid');
        }
      });
    }

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      if (emailInput && isFreeDomain(emailInput.value)) {
        emailError && emailError.classList.remove('hidden');
        emailInput.focus();
        return;
      }

      if (websiteInput && websiteInput.value.trim() && !isValidDomain(websiteInput.value)) {
        websiteError && websiteError.classList.remove('hidden');
        websiteInput.setAttribute('aria-invalid', 'true');
        websiteInput.focus();
        return;
      }

      var hp = form.querySelector('[name="website"]');
      if (hp && hp.value) return;
      var gotcha = form.querySelector('[name="_gotcha"]');
      if (gotcha && gotcha.value) return;

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      var action = form.getAttribute('action');
      if (!action) {
        if (formNote) formNote.textContent = 'Form endpoint not configured — please contact us directly.';
        return;
      }

      if (submitBtn) submitBtn.setAttribute('disabled', 'disabled');
      if (formNote) formNote.textContent = 'Sending…';

      try {
        if (websiteInput && websiteInput.value.trim()) {
          var normalized = normalizeCompanyWebsite(websiteInput.value);
          websiteInput.value = normalized;
        }

        var pageLabel = getSourcePageLabel();
        if (sourcePageInput) sourcePageInput.value = pageLabel;
        if (subjectInput) subjectInput.value = 'New LatAm Scalers Lead';
        if (submissionUrlInput) submissionUrlInput.value = window.location.href;

        try {
          var locRes = await Promise.race([
            fetch('https://ipapi.co/json/').then(function (r) { return r.json(); }).catch(function () { return null; }),
            new Promise(function (r) { setTimeout(function () { r(null); }, 1500); })
          ]);
          if (locRes && locRes.city && locRes.country_name && submissionLocationInput) {
            submissionLocationInput.value = locRes.city + ', ' + locRes.country_name;
          }
        } catch (_) {}

        try {
          var siteKey = (document.documentElement.dataset.recaptchaSiteKey || '').trim();
          if (siteKey && recaptchaToken) {
            var token = await new Promise(function (resolve, reject) {
              var timer = setTimeout(function () { reject(new Error('reCAPTCHA timeout')); }, 6000);
              function run() {
                if (window.grecaptcha && window.grecaptcha.ready) {
                  window.grecaptcha.ready(function () {
                    clearTimeout(timer);
                    window.grecaptcha.execute(siteKey, { action: 'contact_form' }).then(resolve, reject);
                  });
                } else {
                  setTimeout(run, 150);
                }
              }
              run();
            });
            recaptchaToken.value = token;
          }
        } catch (_) {}

        var fd = new FormData(form);
        if (!fd.get('category')) fd.set('category', 'not-specified');
        if (!fd.get('timeline')) fd.set('timeline', 'flexible');
        if (!fd.get('budget_range')) fd.set('budget_range', 'not-specified');
        if (!fd.get('g-recaptcha-response')) fd.delete('g-recaptcha-response');

        var res = await fetch(action, {
          method: 'POST',
          body: fd,
          headers: { Accept: 'application/json' },
          referrerPolicy: 'strict-origin-when-cross-origin',
        });

        if (res.ok) {
          if (formNote) {
            formNote.textContent = 'Thanks — we received your message and will reply shortly.';
            formNote.style.color = 'rgb(110 231 183)';
          }
          form.reset();
        } else {
          if (formNote) {
            formNote.textContent = 'Something went wrong. Please try again or book a call.';
            formNote.style.color = 'rgb(252 165 165)';
          }
        }
      } catch (err) {
        if (formNote) {
          formNote.textContent = 'Something went wrong. Please try again or book a call.';
          formNote.style.color = 'rgb(252 165 165)';
        }
      } finally {
        if (submitBtn) submitBtn.removeAttribute('disabled');
      }
    });
  });
})();
</script>
