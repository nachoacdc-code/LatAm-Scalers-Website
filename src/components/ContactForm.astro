---
export type Props = {
	/** Formspree endpoint, e.g. https://formspree.io/f/xxxxxx */
	action?: string;
	/** Optional redirect URL after submission (Formspree supports `_redirect`) */
	redirectTo?: string;
	/** Optional subject for notifications */
	subject?: string;
	/** Optional role context to include with the submission */
	role?: string;
	/** Optional default selection for category dropdown */
	defaultCategory?: 'aec' | 'design' | 'marketing' | '';
	/** @deprecated use defaultCategory instead */
	defaultInterest?: string;
	/** Optional pre-filled message text */
	defaultMessage?: string;
};

const action =
	Astro.props.action ??
	import.meta.env.PUBLIC_FORMSPREE_ACTION ??
	'';

const redirectTo = Astro.props.redirectTo ?? '';
const subject = Astro.props.subject ?? 'LatAm Scalers — new inquiry';
const role = Astro.props.role ?? '';
const defaultMessage = Astro.props.defaultMessage ?? '';
// Support both prop names for backwards compatibility
const defaultCategory = (Astro.props.defaultCategory ?? Astro.props.defaultInterest ?? '') as 'aec' | 'design' | 'marketing' | '';

const formId = `cf-${Math.random().toString(36).slice(2, 9)}`;
---

<form
	id={formId}
	action={action || undefined}
	method="POST"
	class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6"
	aria-label="Contact form"
	novalidate
	data-contact-form
>
	{/* Qualifier note */}
	<p class="mb-5 text-sm text-slate-400">
		We work exclusively with US-based companies. All fields marked <span class="text-rose-400">*</span> are required.
	</p>

	<div class="grid gap-4 sm:grid-cols-2">

		{/* Name */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-name`}>
				Full name <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-name`}
				name="name"
				autocomplete="name"
				required
				aria-required="true"
			/>
		</div>

		{/* Work Email */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-email`}>
				Work email <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-email`}
				name="email"
				type="email"
				autocomplete="email"
				inputmode="email"
				required
				aria-required="true"
				data-work-email
			/>
			<p class="mt-1 hidden text-xs text-rose-400" data-email-error aria-live="polite">
				Please use your work email (no Gmail, Yahoo, Hotmail, etc.)
			</p>
		</div>

		{/* Company */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-company`}>
				Company <span class="text-rose-400">*</span>
			</label>
			<input
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-company`}
				name="company"
				autocomplete="organization"
				required
				aria-required="true"
			/>
		</div>

		{/* Company Size */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-company-size`}>
				Company size <span class="text-rose-400">*</span>
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-company-size`}
				name="company_size"
				required
				aria-required="true"
			>
				<option value="" selected disabled>Select…</option>
				<option value="1-25">1–25 employees</option>
				<option value="25-200">25–200 employees</option>
				<option value="200+">200+ employees</option>
			</select>
		</div>

		{/* What do you need */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-category`}>
				What do you need? <span class="text-rose-400">*</span>
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-category`}
				name="category"
				required
				aria-required="true"
			>
				<option value="" selected disabled>Select…</option>
				<option value="aec" selected={defaultCategory === 'aec'}>AEC (BIM, CAD, Engineering)</option>
				<option value="design" selected={defaultCategory === 'design'}>Creative & Design</option>
				<option value="marketing" selected={defaultCategory === 'marketing'}>Marketing</option>
				<option value="multiple">Multiple categories</option>
				<option value="not-sure">Not sure yet</option>
			</select>
		</div>

		{/* Timeline */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-timeline`}>
				Timeline <span class="text-rose-400">*</span>
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-timeline`}
				name="timeline"
				required
				aria-required="true"
			>
				<option value="" selected disabled>Select…</option>
				<option value="asap">ASAP</option>
				<option value="1-2-weeks">1–2 weeks</option>
				<option value="2-4-weeks">2–4 weeks</option>
				<option value="flexible">Flexible</option>
			</select>
		</div>

		{/* Budget Range */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-budget`}>
				Monthly budget <span class="text-rose-400">*</span>
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-budget`}
				name="budget_range"
				required
				aria-required="true"
			>
				<option value="" selected disabled>Select…</option>
				<option value="under-2500">Under $2,500/mo</option>
				<option value="2500-5000">$2,500–$5,000/mo</option>
				<option value="5000-10000">$5,000–$10,000/mo</option>
				<option value="10000+">$10,000+/mo</option>
				<option value="not-sure">Not sure yet</option>
			</select>
		</div>

		{/* How did you hear */}
		<div class="sm:col-span-1">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-source`}>
				How did you hear about us?
			</label>
			<select
				class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-source`}
				name="attribution_source"
			>
				<option value="">Select (optional)</option>
				<option value="google">Google Search</option>
				<option value="linkedin">LinkedIn</option>
				<option value="referral">Referral</option>
				<option value="industry-event">Industry Event</option>
				<option value="other">Other</option>
			</select>
		</div>

		{/* US Company checkbox */}
		<div class="sm:col-span-2">
			<label class="flex cursor-pointer items-start gap-3">
				<input
					type="checkbox"
					name="is_us_company"
					value="yes"
					class="mt-0.5 h-4 w-4 shrink-0 rounded border-slate-700 bg-slate-950/60 text-sky-600 focus:ring-sky-300 focus:ring-offset-slate-950"
					required
					aria-required="true"
				/>
				<span class="text-sm text-slate-300">
					I'm a US-based company looking to hire dedicated LATAM talent. <span class="text-rose-400">*</span>
				</span>
			</label>
		</div>

		{/* Message */}
		<div class="sm:col-span-2">
			<label class="text-sm font-medium text-slate-200" for={`${formId}-message`}>
				What do you need help with?
			</label>
			<textarea
				class="mt-2 min-h-24 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				id={`${formId}-message`}
				name="message"
				placeholder="Describe the role, tools, and what success looks like for you."
			>{defaultMessage}</textarea>
		</div>
	</div>

	{/* Honeypot — invisible to humans, filled by bots */}
	<div class="hidden" aria-hidden="true" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;">
		<label for={`${formId}-website`}>Website</label>
		<input id={`${formId}-website`} name="website" tabindex="-1" autocomplete="off" />
	</div>

	<input type="hidden" name="_subject" value={subject} />
	{redirectTo ? <input type="hidden" name="_redirect" value={redirectTo} /> : null}
	{role ? <input type="hidden" name="role" value={role} /> : null}
	<input type="hidden" name="g-recaptcha-response" data-recaptcha-token />

	<div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
		<button
			type="submit"
			class="inline-flex min-h-[44px] items-center justify-center rounded-xl bg-sky-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 disabled:opacity-60"
			data-submit-btn
		>
			Send message
		</button>
		<p class="text-xs text-slate-500" data-form-note aria-live="polite"></p>
	</div>
</form>

<script is:inline>
(function () {
  const FREE_DOMAINS = new Set([
    'gmail.com','yahoo.com','hotmail.com','outlook.com','live.com',
    'icloud.com','me.com','aol.com','msn.com','protonmail.com',
    'ymail.com','mail.com','zoho.com','inbox.com','gmx.com',
  ]);

  document.querySelectorAll('[data-contact-form]').forEach(function (form) {
    var emailInput = form.querySelector('[data-work-email]');
    var emailError = form.querySelector('[data-email-error]');
    var submitBtn  = form.querySelector('[data-submit-btn]');
    var formNote   = form.querySelector('[data-form-note]');
    var recaptchaToken = form.querySelector('[data-recaptcha-token]');

    function isFreeDomain(email) {
      var parts = (email || '').split('@');
      return parts.length === 2 && FREE_DOMAINS.has(parts[1].toLowerCase().trim());
    }

    if (emailInput && emailError) {
      emailInput.addEventListener('blur', function () {
        if (isFreeDomain(emailInput.value)) {
          emailError.classList.remove('hidden');
          emailInput.setAttribute('aria-invalid', 'true');
        } else {
          emailError.classList.add('hidden');
          emailInput.removeAttribute('aria-invalid');
        }
      });
    }

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Work-email check
      if (emailInput && isFreeDomain(emailInput.value)) {
        emailError && emailError.classList.remove('hidden');
        emailInput.focus();
        return;
      }

      // Honeypot check — silently abort if filled
      var hp = form.querySelector('[name="website"]');
      if (hp && hp.value) return;

      var action = form.getAttribute('action');
      if (!action) {
        if (formNote) formNote.textContent = 'Form endpoint not configured — please contact us directly.';
        return;
      }

      if (submitBtn) submitBtn.setAttribute('disabled', 'disabled');
      if (formNote) formNote.textContent = 'Sending…';

      // reCAPTCHA v3 token
      try {
        var siteKey = document.documentElement.dataset.recaptchaSiteKey || '';
        if (siteKey && window.grecaptcha && recaptchaToken) {
          var token = await window.grecaptcha.execute(siteKey, { action: 'contact_form' });
          recaptchaToken.value = token;
        }
      } catch (_) {}

      try {
        var fd = new FormData(form);
        var res = await fetch(action, {
          method: 'POST',
          body: fd,
          headers: { Accept: 'application/json' },
        });

        if (res.ok) {
          if (formNote) {
            formNote.textContent = 'Thanks — we received your message and will reply shortly.';
            formNote.style.color = 'rgb(110 231 183)'; // emerald-300
          }
          form.reset();
        } else {
          if (formNote) {
            formNote.textContent = 'Something went wrong. Please try again or book a call.';
            formNote.style.color = 'rgb(252 165 165)'; // rose-300
          }
        }
      } catch (_) {
        if (formNote) {
          formNote.textContent = 'Network error — please try again.';
          formNote.style.color = 'rgb(252 165 165)';
        }
      } finally {
        if (submitBtn) submitBtn.removeAttribute('disabled');
      }
    });
  });
})();
</script>
