---
/**
 * CalendlyInline — lazy-loaded Calendly inline widget via Intersection Observer.
 * Renders the widget directly with no external-link header.
 * Zero bytes of Calendly JS load until the element enters the viewport.
 */
export type Props = {
	url: string;
	title?: string;
	/** Height in px — Calendly recommends 700+ for the full booking flow */
	height?: number;
};

const { url, title = 'Schedule a call', height = 700 } = Astro.props;
const widgetId = `cal-inline-${Math.random().toString(36).slice(2, 9)}`;
const isCalendly = /calendly\.com/i.test(url);
---

{isCalendly ? (
	<div
		id={widgetId}
		data-calendly-url={url}
		data-calendly-height={height}
		class="overflow-hidden rounded-2xl border border-slate-700/60 bg-white shadow-xl shadow-black/20"
		style={`min-height:${height}px`}
		aria-label={title}
		role="region"
	>
		{/* Skeleton — visible until Calendly widget mounts */}
		<div
			class="flex h-full min-h-[inherit] flex-col items-center justify-start gap-0 bg-white"
			data-calendly-skeleton
		>
			{/* Mimics Calendly's own header layout */}
			<div class="w-full border-b border-gray-100 px-8 py-6">
				<div class="mx-auto flex max-w-sm flex-col items-center gap-3 text-center">
					<div class="h-16 w-16 animate-pulse rounded-full bg-gray-200"></div>
					<div class="h-3 w-32 animate-pulse rounded bg-gray-200"></div>
					<div class="h-5 w-48 animate-pulse rounded bg-gray-300"></div>
					<div class="flex items-center gap-4">
						<div class="h-3 w-16 animate-pulse rounded bg-gray-200"></div>
						<div class="h-3 w-28 animate-pulse rounded bg-gray-200"></div>
					</div>
				</div>
			</div>
			<div class="w-full px-8 py-6">
				<div class="mx-auto max-w-sm">
					<div class="mb-4 h-4 w-36 animate-pulse rounded bg-gray-200"></div>
					<div class="mb-3 flex items-center justify-between">
						<div class="h-7 w-7 animate-pulse rounded-full bg-gray-200"></div>
						<div class="h-4 w-32 animate-pulse rounded bg-gray-200"></div>
						<div class="h-7 w-7 animate-pulse rounded-full bg-gray-200"></div>
					</div>
					<div class="grid grid-cols-7 gap-1">
						{Array.from({ length: 35 }).map(() => (
							<div class="h-8 w-full animate-pulse rounded bg-gray-100"></div>
						))}
					</div>
				</div>
			</div>
		</div>
	</div>
) : (
	<div class="overflow-hidden rounded-2xl border border-slate-700/60 shadow-xl shadow-black/20">
		<iframe
			title={title}
			src={url}
			loading="lazy"
			referrerpolicy="no-referrer-when-downgrade"
			class="w-full"
			style={`height:${height}px`}
		/>
	</div>
)}

<noscript>
	<p class="mt-3 text-sm text-slate-400">
		JavaScript is disabled.
		<a class="underline hover:text-white" href={url} target="_blank" rel="noreferrer">Open Calendly directly →</a>
	</p>
</noscript>

{isCalendly && (
	<script define:vars={{ widgetId, height }}>
	(function () {
	  var SCRIPT_SRC = 'https://assets.calendly.com/assets/external/widget.js';
	  var container  = document.getElementById(widgetId);
	  if (!container) return;

	  var didLoad = false;

	  function initWidget() {
	    var skeleton = container.querySelector('[data-calendly-skeleton]');
	    // Calendly initInlineWidget clears parentElement, so just let it run
	    window.Calendly.initInlineWidget({
	      url: container.dataset.calendlyUrl,
	      parentElement: container,
	    });
	    // Ensure container is tall enough while Calendly bootstraps
	    container.style.minHeight = height + 'px';
	  }

	  function load() {
	    if (didLoad) return;
	    didLoad = true;

	    if (window.Calendly) {
	      initWidget();
	      return;
	    }

	    if (!document.querySelector('script[src="' + SCRIPT_SRC + '"]')) {
	      var s   = document.createElement('script');
	      s.src   = SCRIPT_SRC;
	      s.async = true;
	      s.onload = initWidget;
	      document.head.appendChild(s);
	    } else {
	      var t = setInterval(function () {
	        if (window.Calendly) { clearInterval(t); initWidget(); }
	      }, 150);
	      setTimeout(function () { clearInterval(t); }, 6000);
	    }
	  }

	  if ('IntersectionObserver' in window) {
	    var obs = new IntersectionObserver(
	      function (entries) {
	        if (entries[0].isIntersecting) { obs.disconnect(); load(); }
	      },
	      { rootMargin: '300px' }
	    );
	    obs.observe(container);
	  } else {
	    load();
	  }
	})();
	</script>
)}
