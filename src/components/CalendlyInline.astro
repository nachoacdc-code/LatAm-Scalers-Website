---
/**
 * CalendlyInline — lazy-loaded Calendly inline widget via Intersection Observer.
 * Zero bytes of Calendly JS load until the contact section enters the viewport.
 * Dark-theme enforced via URL params + CSS overrides (no white bleed).
 * Exposes window._latamCalendlyPreloaders[] so ContactHub can trigger early load.
 */
export type Props = {
	url: string;
	title?: string;
	height?: number;
};

const { url: rawUrl, title = 'Schedule a call', height = 700 } = Astro.props;

const isCalendly = /calendly\.com/i.test(rawUrl);
const isPlaceholder = /your-org|yourFormId|example/i.test(rawUrl);

// Dark theme params — background matches #0F172A (slate-950), primary = brand blue
function themedUrl(base: string) {
	const sep = base.includes('?') ? '&' : '?';
	return `${base}${sep}embed_type=inline&hide_event_type_details=1&hide_gdpr_banner=1&background_color=0F172A&text_color=ffffff&primary_color=2563EB`;
}

const url = isCalendly && !isPlaceholder ? themedUrl(rawUrl) : rawUrl;
const widgetId = `cal-inline-${Math.random().toString(36).slice(2, 9)}`;
---

{isCalendly && !isPlaceholder ? (
	<div
		id={widgetId}
		data-calendly-url={url}
		data-calendly-height={height}
		class="calendly-host overflow-hidden rounded-2xl border border-slate-700/60"
		style={`min-height:${height}px;background:#0F172A`}
		aria-label={title}
		role="region"
	>
		{/* Skeleton shimmer — matches Calendly's dark layout */}
		<div
			class="flex h-full min-h-[inherit] flex-col items-center justify-start gap-0"
			data-calendly-skeleton
			style="background:#0F172A"
		>
			<div class="w-full border-b border-slate-800 px-8 py-6" style="background:#0F172A">
				<div class="mx-auto flex max-w-sm flex-col items-center gap-3 text-center">
					<div class="h-16 w-16 animate-pulse rounded-full bg-slate-800"></div>
					<div class="h-3 w-32 animate-pulse rounded bg-slate-800"></div>
					<div class="h-5 w-48 animate-pulse rounded bg-slate-800"></div>
					<div class="flex items-center gap-4">
						<div class="h-3 w-16 animate-pulse rounded bg-slate-800"></div>
						<div class="h-3 w-28 animate-pulse rounded bg-slate-800"></div>
					</div>
				</div>
			</div>
			<div class="w-full px-8 py-6" style="background:#0F172A">
				<div class="mx-auto max-w-sm">
					<div class="mb-4 h-4 w-36 animate-pulse rounded bg-slate-800"></div>
					<div class="mb-3 flex items-center justify-between">
						<div class="h-7 w-7 animate-pulse rounded-full bg-slate-800"></div>
						<div class="h-4 w-32 animate-pulse rounded bg-slate-800"></div>
						<div class="h-7 w-7 animate-pulse rounded-full bg-slate-800"></div>
					</div>
					<div class="grid grid-cols-7 gap-1">
						{Array.from({ length: 35 }).map(() => (
							<div class="h-8 w-full animate-pulse rounded bg-slate-800/60"></div>
						))}
					</div>
				</div>
			</div>
		</div>
	</div>
) : (
	<div class="flex flex-col items-center justify-center rounded-2xl border border-slate-700/60 bg-slate-900/40 p-10 text-center" style={`min-height:320px`}>
		<div class="flex h-14 w-14 items-center justify-center rounded-full border border-slate-700 bg-slate-800">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
			</svg>
		</div>
		<h3 class="mt-4 text-lg font-semibold text-slate-100">Book a Scoping Call</h3>
		<p class="mt-2 max-w-xs text-sm leading-relaxed text-slate-400">
			Calendar booking will be available once our scheduling link is configured. In the meantime, send us a message and we'll reach out within 24 hours.
		</p>
	</div>
)}

<noscript>
	<p class="mt-3 text-sm text-slate-400">
		JavaScript is disabled.
		<a class="underline hover:text-white" href={rawUrl} target="_blank" rel="noreferrer">Open Calendly directly →</a>
	</p>
</noscript>

{/* Global CSS — eliminates white bleed from Calendly's injected wrapper */}
<style is:global>
	.calendly-host,
	.calendly-host .calendly-inline-widget,
	.calendly-host .calendly-inline-widget > div,
	.calendly-host iframe {
		background: #0F172A !important;
		background-color: #0F172A !important;
	}
	.calendly-inline-widget {
		background: #0F172A !important;
		background-color: #0F172A !important;
	}
	.calendly-inline-widget iframe {
		background: #0F172A !important;
		border: none !important;
		box-shadow: none !important;
	}
</style>

{isCalendly && !isPlaceholder && (
	<script define:vars={{ widgetId, height }}>
	(function () {
	  var SCRIPT_SRC = 'https://assets.calendly.com/assets/external/widget.js';
	  var CSS_SRC    = 'https://assets.calendly.com/assets/external/widget.css';
	  var container  = document.getElementById(widgetId);
	  if (!container) return;

	  var didLoad = false;

	  function injectCSS() {
	    if (!document.querySelector('link[href="' + CSS_SRC + '"]')) {
	      var link  = document.createElement('link');
	      link.rel  = 'stylesheet';
	      link.href = CSS_SRC;
	      document.head.appendChild(link);
	    }
	  }

	  function fixColors() {
	    container.style.background = '#0F172A';
	    var iframe = container.querySelector('iframe');
	    if (iframe) {
	      iframe.style.width = '100%';
	      iframe.style.minHeight = height + 'px';
	      iframe.style.border = 'none';
	      iframe.style.boxShadow = 'none';
	      iframe.style.background = '#0F172A';
	      iframe.style.backgroundColor = '#0F172A';
	    }
	    var widget = container.querySelector('.calendly-inline-widget');
	    if (widget) {
	      widget.style.background = '#0F172A';
	      widget.style.backgroundColor = '#0F172A';
	      widget.style.minHeight = height + 'px';
	    }
	  }

	  function initWidget() {
	    var skeleton = container.querySelector('[data-calendly-skeleton]');
	    if (skeleton) skeleton.style.display = 'none';
	    window.Calendly.initInlineWidget({
	      url: container.dataset.calendlyUrl,
	      parentElement: container,
	    });
	    container.style.minHeight = height + 'px';
	    fixColors();
	    // Poll until iframe appears, then lock down colors
	    var attempts = 0;
	    var check = setInterval(function () {
	      fixColors();
	      var iframe = container.querySelector('iframe');
	      if (iframe && ++attempts > 5) clearInterval(check);
	      if (attempts > 80) clearInterval(check);
	    }, 200);
	  }

	  function load() {
	    if (didLoad) return;
	    didLoad = true;
	    injectCSS();
	    if (window.Calendly) {
	      initWidget();
	      return;
	    }
	    if (!document.querySelector('script[src="' + SCRIPT_SRC + '"]')) {
	      var s   = document.createElement('script');
	      s.src   = SCRIPT_SRC;
	      s.async = true;
	      s.onload = initWidget;
	      document.head.appendChild(s);
	    } else {
	      var t = setInterval(function () {
	        if (window.Calendly) { clearInterval(t); initWidget(); }
	      }, 150);
	      setTimeout(function () { clearInterval(t); }, 6000);
	    }
	  }

	  // --- Intelligent Lazy Loading ---

	  // 1. Register in global preloader registry (ContactHub triggers this)
	  if (!window._latamCalendlyPreloaders) window._latamCalendlyPreloaders = [];
	  window._latamCalendlyPreloaders.push(load);

	  // 2. Observe the nearest contact section (not the hidden panel itself)
	  var observeTarget = (
	    container.closest('[data-contact-hub]') ||
	    container.closest('#contact') ||
	    document.getElementById('contact') ||
	    container
	  );

	  if ('IntersectionObserver' in window) {
	    var obs = new IntersectionObserver(
	      function (entries) {
	        if (entries[0].isIntersecting) { obs.disconnect(); load(); }
	      },
	      { rootMargin: '500px' }
	    );
	    obs.observe(observeTarget);
	  } else {
	    load();
	  }

	  // 3. Pre-warm on hover of any primary CTA
	  function onCTAHover(e) {
	    var t = e.target && e.target.closest ? e.target.closest(
	      '[data-book-call],[data-scroll-to-contact],[data-open-tell-us]'
	    ) : null;
	    if (t) {
	      document.removeEventListener('mouseover', onCTAHover);
	      document.removeEventListener('touchstart', onCTAHover);
	      load();
	    }
	  }
	  document.addEventListener('mouseover', onCTAHover, { passive: true });
	  document.addEventListener('touchstart', onCTAHover, { passive: true });
	})();
	</script>
)}
