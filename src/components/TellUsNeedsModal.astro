---
import { BOOKING_URL, getFormspreeAction, isCalendlyUrl, isExternalUrl } from '../lib/cta';

export type Props = {
	subject?: string;
};

const subject = Astro.props.subject ?? 'LatAm Scalers — Tell Us Your Needs';
const formAction = getFormspreeAction();
const bookingUrl = BOOKING_URL;
const shouldLoadCalendlyWidget = isCalendlyUrl(bookingUrl);
const bookingExternal = isExternalUrl(bookingUrl);
---

<dialog
	id="tell-us-modal"
	class="backdrop:bg-black/60 backdrop:backdrop-blur-sm rounded-2xl border border-slate-800 bg-slate-950 text-slate-100 shadow-2xl shadow-black/40"
	aria-label="Tell us your needs"
>
	<div class="w-[min(760px,calc(100vw-2rem))] p-5 sm:p-6">
		<div class="flex items-start justify-between gap-4">
			<div>
				<p class="text-xs font-semibold uppercase tracking-wide text-sky-300">Tell us your needs</p>
				<h2 class="mt-2 text-xl font-semibold tracking-tight text-white sm:text-2xl">Get matched fast</h2>
				<p class="mt-1.5 text-sm leading-relaxed text-slate-400">
					Share a few details and we'll reply with vetted options within 48 hours.
				</p>
			</div>
			<button
				type="button"
				class="shrink-0 rounded-xl border border-slate-800 bg-slate-900/60 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				data-tell-us-close
				aria-label="Close dialog"
			>
				Close
			</button>
		</div>

		<div class="mt-5 grid gap-4 lg:grid-cols-3">
			<form
				class="lg:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/40 p-5"
				method="POST"
				action={formAction || undefined}
				data-tell-us-form
				novalidate
			>
				<div class="grid gap-4 sm:grid-cols-2">

					{/* Name */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-name">
							Full name <span class="text-rose-400">*</span>
						</label>
						<input
							id="t-name"
							name="name"
							autocomplete="name"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						/>
					</div>

					{/* Work Email */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-email">
							Work email <span class="text-rose-400">*</span>
						</label>
						<input
							id="t-email"
							name="email"
							type="email"
							autocomplete="email"
							inputmode="email"
							required
							aria-required="true"
							data-work-email-modal
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						/>
						<p class="mt-1 hidden text-xs text-rose-400" data-modal-email-error aria-live="polite">
							Please use your work email (no Gmail, Yahoo, Hotmail, etc.)
						</p>
					</div>

					{/* Company */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-company">
							Company <span class="text-rose-400">*</span>
						</label>
						<input
							id="t-company"
							name="company"
							autocomplete="organization"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						/>
					</div>

					{/* Company Size */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-company-size">
							Company size <span class="text-rose-400">*</span>
						</label>
						<select
							id="t-company-size"
							name="company_size"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						>
							<option value="" selected disabled>Select…</option>
							<option value="1-25">1–25 employees</option>
							<option value="25-50">25–50 employees</option>
							<option value="50-100">50–100 employees</option>
							<option value="100-200">100–200 employees</option>
							<option value="200+">200+ employees</option>
						</select>
					</div>

					{/* What do you need */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-category">
							What do you need? <span class="text-rose-400">*</span>
						</label>
						<select
							id="t-category"
							name="category"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
							data-tell-us-category
						>
							<option value="" selected disabled>Select…</option>
							<option value="aec">AEC (BIM, CAD, Engineering)</option>
							<option value="design">Creative & Design</option>
							<option value="marketing">Marketing</option>
							<option value="multiple">Multiple categories</option>
							<option value="not-sure">Not sure yet</option>
						</select>
					</div>

					{/* Budget Range */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-budget">
							Monthly budget <span class="text-rose-400">*</span>
						</label>
						<select
							id="t-budget"
							name="budget_range"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						>
							<option value="" selected disabled>Select…</option>
							<option value="under-2500">Under $2,500/mo</option>
							<option value="2500-5000">$2,500–$5,000/mo</option>
							<option value="5000-10000">$5,000–$10,000/mo</option>
							<option value="10000+">$10,000+/mo</option>
							<option value="not-sure">Not sure yet</option>
						</select>
					</div>

					{/* Preferred start */}
					<div class="sm:col-span-1">
						<label class="text-sm font-medium text-slate-200" for="t-start">
							Timeline <span class="text-rose-400">*</span>
						</label>
						<select
							id="t-start"
							name="preferred_start"
							required
							aria-required="true"
							class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						>
							<option value="" selected disabled>Select…</option>
							<option value="asap">ASAP</option>
							<option value="1-2-weeks">1–2 weeks</option>
							<option value="2-4-weeks">2–4 weeks</option>
							<option value="flexible">Flexible</option>
						</select>
					</div>

					{/* Attribution source */}
					<div class="sm:col-span-1">
					<label class="text-sm font-medium text-slate-200" for="t-source">
						How did you hear about us? <span class="text-rose-400">*</span>
					</label>
					<select
						id="t-source"
						name="attribution_source"
						required
						aria-required="true"
						class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
					>
						<option value="" selected disabled>Select…</option>
						<option value="google">Google Search</option>
						<option value="linkedin">LinkedIn</option>
						<option value="ai-llm">AI Assistant (ChatGPT, Claude, Gemini…)</option>
						<option value="referral">Referral</option>
						<option value="industry-event">Industry Event</option>
						<option value="other">Other</option>
					</select>
					</div>

					{/* Role / need */}
					<div class="sm:col-span-2">
						<label class="text-sm font-medium text-slate-200" for="t-need">
							Describe your need <span class="text-slate-500">(optional)</span>
						</label>
						<textarea
							id="t-need"
							name="need"
							class="mt-2 min-h-24 w-full rounded-xl border border-slate-800 bg-slate-950/60 px-4 py-2.5 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
							placeholder="Role, tools, availability, what 'good' looks like for you."
						></textarea>
					</div>

					{/* US Company qualifier */}
					<div class="sm:col-span-2">
						<label class="flex cursor-pointer items-start gap-3">
							<input
								type="checkbox"
								name="is_us_company"
								value="yes"
								required
								aria-required="true"
								class="mt-0.5 h-4 w-4 shrink-0 rounded border-slate-700 bg-slate-950/60 text-sky-600 focus:ring-sky-300 focus:ring-offset-slate-950"
							/>
							<span class="text-sm text-slate-300">
								I'm a company looking to hire dedicated LATAM talent. <span class="text-rose-400">*</span>
							</span>
						</label>
					</div>
				</div>

				{/* Honeypot */}
				<div aria-hidden="true" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;">
					<label for="t-website">Website</label>
					<input id="t-website" name="website" tabindex="-1" autocomplete="off" />
				</div>

				<input type="hidden" name="_subject" value={subject} />
				<input type="hidden" name="page_url" value="" data-tell-us-page-url />
				<input type="hidden" name="cta_source" value="" data-tell-us-cta-source />
				<input type="hidden" name="cta_role" value="" data-tell-us-cta-role />
				<input type="hidden" name="g-recaptcha-response" data-recaptcha-token-modal />

				<div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
					<button
						type="submit"
						class="inline-flex min-h-[44px] items-center justify-center rounded-xl bg-sky-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 disabled:opacity-60"
						data-tell-us-submit
					>
						Send
					</button>

					<a
						href={bookingUrl}
						{...(bookingExternal ? { target: '_blank', rel: 'noreferrer' } : {})}
						class="inline-flex min-h-[44px] items-center justify-center rounded-xl border border-slate-800 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-slate-100 transition hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						data-book-call
					>
						Prefer to book a call
					</a>
				</div>

				<p class="mt-4 text-sm text-slate-300" data-tell-us-status hidden aria-live="polite"></p>
			</form>

			<aside class="rounded-2xl border border-slate-800 bg-slate-900/40 p-5">
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-400">What happens next</p>
				<ul class="mt-4 grid gap-2 text-sm text-slate-300">
					<li class="rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3">We confirm scope + timeline</li>
					<li class="rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3">Vetted options in ~48 hours</li>
					<li class="rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3">Interview optional — start month-to-month</li>
				</ul>
				<div class="mt-5 space-y-3 text-xs text-slate-500">
					<p>✓ Pre-vetted talent only — less than 3% of applicants pass</p>
					<p>✓ Month-to-month flexibility</p>
					<p>✓ Free replacement guarantee</p>
				</div>
			</aside>
		</div>
	</div>
</dialog>

<script is:inline>
(function () {
  var FREE_DOMAINS = new Set([
    'gmail.com','yahoo.com','hotmail.com','outlook.com','live.com',
    'icloud.com','me.com','aol.com','msn.com','protonmail.com',
    'ymail.com','mail.com','zoho.com','inbox.com','gmx.com',
  ]);

  var dialog = document.getElementById('tell-us-modal');
  if (!(dialog instanceof HTMLDialogElement)) return;

  var form        = dialog.querySelector('[data-tell-us-form]');
  var status      = dialog.querySelector('[data-tell-us-status]');
  var submitBtn   = dialog.querySelector('[data-tell-us-submit]');
  var pageUrl     = dialog.querySelector('[data-tell-us-page-url]');
  var ctaSource   = dialog.querySelector('[data-tell-us-cta-source]');
  var ctaRole     = dialog.querySelector('[data-tell-us-cta-role]');
  var emailInput  = dialog.querySelector('[data-work-email-modal]');
  var emailError  = dialog.querySelector('[data-modal-email-error]');
  var categorySel = dialog.querySelector('[data-tell-us-category]');
  var recaptchaToken = dialog.querySelector('[data-recaptcha-token-modal]');

  function isFreeDomain(email) {
    var parts = (email || '').split('@');
    return parts.length === 2 && FREE_DOMAINS.has(parts[1].toLowerCase().trim());
  }

  function setStatus(message, type) {
    if (!status) return;
    status.hidden = !message;
    status.textContent = message || '';
    status.className = 'mt-4 text-sm';
    if (type === 'success') status.style.color = 'rgb(110 231 183)';
    else if (type === 'error') status.style.color = 'rgb(252 165 165)';
    else status.style.color = 'rgb(203 213 225)';
  }

  function openDialog(sourceLabel, roleLabel, category) {
    setStatus('', 'info');
    if (submitBtn) submitBtn.removeAttribute('disabled');
    if (pageUrl)   pageUrl.value   = window.location.href;
    if (ctaSource) ctaSource.value = sourceLabel || '';
    if (ctaRole)   ctaRole.value   = roleLabel   || '';
    // Pre-select category if provided
    if (categorySel && category) {
      for (var i = 0; i < categorySel.options.length; i++) {
        if (categorySel.options[i].value === category) {
          categorySel.selectedIndex = i;
          break;
        }
      }
    }
    dialog.showModal();
    var first = dialog.querySelector('input:not([type="hidden"]), textarea, select');
    first && first.focus();
  }

  function closeDialog() { dialog.close(); }

  dialog.querySelectorAll('[data-tell-us-close]').forEach(function (btn) {
    btn.addEventListener('click', closeDialog);
  });

  dialog.addEventListener('click', function (e) {
    var rect = dialog.getBoundingClientRect();
    var inDialog = rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
                   rect.left <= e.clientX && e.clientX <= rect.left + rect.width;
    if (!inDialog) closeDialog();
  });

  dialog.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeDialog();
  });

  if (emailInput && emailError) {
    emailInput.addEventListener('blur', function () {
      if (isFreeDomain(emailInput.value)) {
        emailError.classList.remove('hidden');
        emailInput.setAttribute('aria-invalid', 'true');
      } else {
        emailError.classList.add('hidden');
        emailInput.removeAttribute('aria-invalid');
      }
    });
  }

  // ── Same-page scroll utility ────────────────────────────────────────────────
  // Scrolls to #contact on the current page.
  // activateTab: 'form' | 'calendly-preload' | null
  // NOTE: 'calendly-preload' means pre-load Calendly in the background but keep
  //       the form tab visible — so the user can choose to fill the form OR click
  //       the Calendly tab themselves without any delay.
  function scrollToContact(activateTab) {
    var contactEl = document.getElementById('contact');
    if (!contactEl) {
      // No contact section on this page — navigate to homepage contact
      window.location.href = '/#contact';
      return;
    }
    contactEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Always pre-warm Calendly so the tab is instant when the user clicks it
    setTimeout(function () {
      var preloaders = window._latamCalendlyPreloaders || [];
      preloaders.forEach(function (fn) { try { fn(); } catch (e_) {} });
    }, 150);

    // Only explicitly switch to form tab (for "Tell Us What You Need" CTAs)
    if (activateTab === 'form' && window.latamHub && window.latamHub.activateForm) {
      setTimeout(function () { window.latamHub.activateForm(); }, 400);
    }
    // 'calendly-preload' → keep form tab active, Calendly pre-warms silently
  }

  // ── Global click delegation ──────────────────────────────────────────────────
  // All CTAs across the site use data attributes — handled here centrally.
  document.addEventListener('click', function (e) {
    var target = e.target;
    if (!(target instanceof Element)) return;

    // "Tell Us What You Need" / "Get Started" / form CTAs → scroll to form tab
    var opener = target.closest('[data-open-tell-us],[data-open-contact-modal]');
    if (opener) {
      e.preventDefault();
      scrollToContact('form');
      return;
    }

    // "Book a Call" CTAs → scroll to contact section, pre-load Calendly, keep form tab visible
    // The user can then choose to click the "Book a 30-min scoping call" tab (already pre-loaded)
    var book = target.closest('[data-book-call]');
    if (book) {
      e.preventDefault();
      scrollToContact('calendly-preload');
      return;
    }

    // "Get Started" in Nav + any other scroll-to-contact CTAs
    var scrollCta = target.closest('[data-scroll-to-contact]');
    if (scrollCta) {
      e.preventDefault();
      var tabHint = scrollCta.getAttribute('data-scroll-to-contact') || 'form';
      scrollToContact(tabHint === 'calendly' ? 'calendly-preload' : 'form');
      return;
    }

    // Catch remaining bookingUrl/Calendly/contact links without explicit data attrs
    var link = target.closest('a');
    if (link) {
      var href = link.getAttribute('href') || '';
      // External Calendly URLs → scroll to contact, pre-load Calendly (no popup)
      if (/calendly\.com/i.test(href) && !link.getAttribute('target')) {
        e.preventDefault();
        scrollToContact('calendly-preload');
        return;
      }
      // Anchor #contact links → scroll to contact (handles same-page and /#contact)
      if (href === '#contact' || href.endsWith('#contact')) {
        e.preventDefault();
        scrollToContact('form');
        return;
      }
    }
  });

  form && form.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!(form instanceof HTMLFormElement)) return;

    // Work-email guard
    if (emailInput && isFreeDomain(emailInput.value)) {
      emailError && emailError.classList.remove('hidden');
      emailInput.focus();
      return;
    }

    // Honeypot — silent discard
    var hp = form.querySelector('[name="website"]');
    if (hp && hp.value) { closeDialog(); return; }

    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    var action = form.getAttribute('action') || '';
    if (!action) {
      setStatus('Form endpoint not configured. Please book a call instead.', 'error');
      return;
    }

    if (submitBtn) submitBtn.setAttribute('disabled', 'disabled');
    setStatus('Sending…', 'info');

    // reCAPTCHA v3 token
    try {
      var siteKey = document.documentElement.dataset.recaptchaSiteKey || '';
      if (siteKey && window.grecaptcha && recaptchaToken) {
        var token = await window.grecaptcha.execute(siteKey, { action: 'tell_us_modal' });
        recaptchaToken.value = token;
      }
    } catch (_) {}

    try {
      var fd = new FormData(form);
      var res = await fetch(action, {
        method: 'POST',
        body: fd,
        headers: { Accept: 'application/json' },
      });
      if (res.ok) {
        setStatus('Thanks — we received your details and will reply within 48 hours.', 'success');
        form.reset();
      } else {
        setStatus('Something went wrong. Please try again or book a call directly.', 'error');
      }
    } catch (_) {
      setStatus('Network error — please try again.', 'error');
    } finally {
      if (submitBtn) submitBtn.removeAttribute('disabled');
    }
  });
})();
</script>
