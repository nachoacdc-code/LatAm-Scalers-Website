---
export type Props = {
	url: string;
	title?: string;
	loadOnClick?: boolean;
};

const { url, title = 'Book a 15-minute intro call', loadOnClick = true } = Astro.props;
const embedId = `calendly-${Math.random().toString(36).slice(2, 10)}`;
---

<div class="rounded-2xl border border-border bg-white p-6 shadow-sm">
	<div class="flex items-start justify-between gap-4">
		<div>
			<h3 class="text-base font-semibold text-text-primary">{title}</h3>
			<p class="mt-2 text-sm leading-relaxed text-text-secondary">
				Prefer scheduling? Pick a time that works and we'll meet for a quick 15-minute intro.
			</p>
		</div>
		<a
			class="shrink-0 rounded-lg border border-border bg-bg-alt px-4 py-2 text-sm font-semibold text-text-primary transition hover:bg-border focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
			href={url}
			target="_blank"
			rel="noreferrer"
		>
			Open Calendly
		</a>
	</div>

	<div class="mt-5">
		{loadOnClick ? (
			<div class="rounded-xl border border-border bg-bg-alt p-4">
				<p class="text-sm text-text-secondary">
					To keep the page fast, the Calendly scheduler loads only when you ask for it.
				</p>
				<div class="mt-4 flex flex-wrap gap-3">
					<button
						type="button"
						class="inline-flex items-center justify-center rounded-lg bg-accent px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-accent/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
						data-calendly-load
						aria-controls={embedId}
					>
						Load scheduler
					</button>
					<a
						class="inline-flex items-center justify-center rounded-lg border border-border bg-white px-4 py-2 text-sm font-semibold text-text-primary transition hover:bg-bg-alt focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
						href={url}
						target="_blank"
						rel="noreferrer"
					>
						Open in a new tab
					</a>
				</div>

				<div
					id={embedId}
					data-calendly-container
					data-calendly-url={url}
					data-calendly-title={title}
					class="mt-5 overflow-hidden rounded-xl border border-border bg-white"
				/>

				<noscript>
					<p class="mt-4 text-sm text-text-secondary">
						JavaScript is disabled. Please use{' '}
						<a class="underline hover:text-accent" href={url} target="_blank" rel="noreferrer">
							this Calendly link
						</a>
						.
					</p>
				</noscript>
			</div>
		) : (
			<div class="overflow-hidden rounded-xl border border-border bg-white">
				<iframe
					title={title}
					src={url}
					loading="lazy"
					referrerpolicy="no-referrer-when-downgrade"
					class="h-[720px] w-full"
				/>
			</div>
		)}
	</div>
</div>

{loadOnClick ? (
	<script is:inline>
		{`(() => {
  const root = document.currentScript?.previousElementSibling;
  if (!root) return;
  const btn = root.querySelector('[data-calendly-load]');
  const container = root.querySelector('[data-calendly-container]');
  if (!btn || !container) return;
  btn.addEventListener('click', () => {
    if (container.dataset.loaded === 'true') return;
    const url = container.dataset.calendlyUrl;
    const title = container.dataset.calendlyTitle || 'Calendly';
    if (!url) return;
    const iframe = document.createElement('iframe');
    iframe.title = title;
    iframe.src = url;
    iframe.loading = 'lazy';
    iframe.referrerPolicy = 'no-referrer-when-downgrade';
    iframe.className = 'h-[720px] w-full';
    container.appendChild(iframe);
    container.dataset.loaded = 'true';
    btn.setAttribute('disabled', 'disabled');
    btn.classList.add('opacity-60');
  });
})();`}
	</script>
) : null}
