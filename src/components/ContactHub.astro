---
/**
 * ContactHub — toggle-tab component: "Send a Message" / "Book a Call"
 * Left panel: prominent benefits + toggle tabs.
 * Right panel: swaps between ContactForm and CalendlyInline.
 * Exposes window.latamHub API for external scroll-to-contact CTAs.
 */
import ContactForm from './ContactForm.astro';
import CalendlyInline from './CalendlyInline.astro';

export type Props = {
	subject?: string;
	calendlyUrl?: string;
	defaultCategory?: 'aec' | 'design' | 'marketing' | '';
	/** @deprecated — use defaultCategory */
	defaultInterest?: string;
	defaultMessage?: string;
	heading?: string;
	subheading?: string;
};

const {
	subject = 'LatAm Scalers — new inquiry',
	calendlyUrl = import.meta.env.PUBLIC_CALENDLY_URL ?? import.meta.env.PUBLIC_BOOKING_URL ?? 'https://calendly.com/alejandra-latamscalers/30min',
	defaultCategory = (Astro.props.defaultCategory ?? Astro.props.defaultInterest ?? '') as 'aec' | 'design' | 'marketing' | '',
	defaultMessage = '',
	heading = 'Get in Touch',
	subheading = 'Send us a message with your requirements, or book a quick scoping call — whatever works best for you.',
} = Astro.props;

const hubId = `hub-${Math.random().toString(36).slice(2, 8)}`;
---

<div id={hubId} class="contact-hub" data-contact-hub>
	{/* Outer wrapper */}
	<div class="relative rounded-3xl border border-sky-500/20 bg-gradient-to-br from-slate-900 via-slate-900/95 to-slate-950 shadow-2xl shadow-sky-900/10">

		{/* Top accent bar */}
		<div class="h-1 rounded-t-3xl bg-gradient-to-r from-sky-500 via-sky-400 to-cyan-400"></div>

		<div class="grid gap-0 lg:grid-cols-[380px_1fr]">

			{/* Left panel: prominent benefits + toggle tabs */}
			<div class="flex flex-col gap-5 p-7 lg:border-r lg:border-slate-800/60 lg:p-8">

				<div>
					<h2 class="text-2xl font-bold tracking-tight text-white lg:text-[1.65rem]">{heading}</h2>
					<p class="mt-2 text-[0.9rem] leading-relaxed text-slate-300">{subheading}</p>
				</div>

				{/* ── TAB BUTTONS FIRST — highest priority ── */}
				<div class="flex flex-col gap-3">
					<button
						type="button"
						class="group flex w-full items-center justify-between rounded-xl px-5 py-5 text-left transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						data-hub-tab="form"
						aria-selected="true"
						role="tab"
					>
						<div>
							<p class="text-base font-semibold leading-snug" data-tab-title>Send us a message</p>
							<p class="mt-1 text-sm" data-tab-sub>We reply within a few hours</p>
						</div>
						<svg class="h-5 w-5 shrink-0 opacity-0 transition-opacity" data-tab-arrow viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd"/></svg>
					</button>

					<button
						type="button"
						class="group flex w-full items-center justify-between rounded-xl px-5 py-5 text-left transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
						data-hub-tab="calendly"
						aria-selected="false"
						role="tab"
					>
						<div>
							<p class="text-base font-semibold leading-snug" data-tab-title>Book a 30-min scoping call</p>
							<p class="mt-1 text-sm leading-snug" data-tab-sub>Learn exactly how LatAm Scalers works and how we can add reliable capacity to your team in under one week.</p>
						</div>
						<svg class="h-5 w-5 shrink-0 opacity-0 transition-opacity" data-tab-arrow viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd"/></svg>
					</button>
				</div>

				{/* ── VETTING FUNNEL — trust visual (no client logos yet) ── */}
				<a href="/about/how-we-vet/" class="mt-4 flex items-center gap-3 rounded-xl border border-slate-800/60 bg-slate-950/40 px-4 py-3 transition hover:border-sky-500/30 hover:bg-slate-900/60">
					<div class="flex shrink-0 items-center gap-1">
						<span class="text-lg font-bold text-sky-400">500+</span>
						<span class="text-[0.65rem] font-medium uppercase tracking-wider text-slate-500">applicants</span>
					</div>
					<svg class="h-4 w-4 shrink-0 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.06l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"/></svg>
					<div class="flex shrink-0 items-center gap-1">
						<span class="text-sm font-semibold text-slate-300">5-stage</span>
						<span class="text-[0.65rem] font-medium uppercase tracking-wider text-slate-500">screening</span>
					</div>
					<svg class="h-4 w-4 shrink-0 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.06l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"/></svg>
					<div class="flex shrink-0 items-center gap-1">
						<span class="text-lg font-bold text-emerald-400">&lt;3%</span>
						<span class="text-[0.65rem] font-medium uppercase tracking-wider text-slate-500">placed</span>
					</div>
					<span class="ml-auto text-xs font-medium text-sky-400">How we vet →</span>
				</a>

				{/* ── BENEFITS — below tabs so CTAs stay priority ── */}
				<div class="mt-auto border-t border-slate-800/60 pt-5">
					<p class="mb-3 text-sm font-semibold text-slate-200">Built for US teams that need to move fast</p>
					<div class="grid grid-cols-2 gap-3">
						<div class="flex items-start gap-2">
							<span class="mt-0.5 flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-400">
								<svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/></svg>
							</span>
							<div>
								<p class="text-sm font-semibold text-slate-200">Matched in under one week</p>
								<p class="text-xs text-slate-500">Vetted shortlist in 48 hours</p>
							</div>
						</div>
						<div class="flex items-start gap-2">
							<span class="mt-0.5 flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-sky-500/15 text-sky-400">
								<svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/></svg>
							</span>
							<div>
								<p class="text-sm font-semibold text-slate-200">Month-to-month, no lock-in</p>
								<p class="text-xs text-slate-500">Scale up or pause anytime</p>
							</div>
						</div>
						<div class="flex items-start gap-2">
							<span class="mt-0.5 flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-400">
								<svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/></svg>
							</span>
							<div>
								<p class="text-sm font-semibold text-slate-200">Free replacement guarantee</p>
								<p class="text-xs text-slate-500">We fix the fit — at no cost</p>
							</div>
						</div>
						<a href="/about/how-we-vet/" class="flex items-start gap-2 transition hover:opacity-90">
							<span class="mt-0.5 flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-sky-500/15 text-sky-400">
								<svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/></svg>
							</span>
							<div>
								<p class="text-sm font-semibold text-slate-200">50–70% cost savings</p>
								<p class="text-xs text-slate-500 underline decoration-slate-600 transition hover:decoration-sky-400">&lt;3% pass our vetting →</p>
							</div>
						</a>
					</div>
				</div>

			</div>

			{/* Right: content panel */}
			<div class="min-h-[500px]">

				{/* Form panel */}
				<div class="p-5 sm:p-7" data-hub-panel="form">
					<ContactForm
						subject={subject}
						defaultCategory={defaultCategory}
						defaultMessage={defaultMessage}
					/>
				</div>

				{/* Calendly panel */}
				<div class="hidden p-5 sm:p-7" data-hub-panel="calendly">
					<CalendlyInline url={calendlyUrl} title="Book a 30-Minute Scoping Call" height={700} />
				</div>
			</div>
		</div>
	</div>
</div>

<script is:inline>
(function () {
  document.querySelectorAll('[data-contact-hub]').forEach(function (hub) {
    var tabs   = hub.querySelectorAll('[data-hub-tab]');
    var panels = hub.querySelectorAll('[data-hub-panel]');

    function activate(name) {
      tabs.forEach(function (tab) {
        var isActive = tab.dataset.hubTab === name;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');

        if (isActive) {
          tab.style.backgroundColor = 'rgba(2,132,199,0.12)';
          tab.style.border = '1px solid rgba(14,165,233,0.35)';
        } else {
          tab.style.backgroundColor = '';
          tab.style.border = '1px solid transparent';
        }

        var titleEl = tab.querySelector('[data-tab-title]');
        var subEl   = tab.querySelector('[data-tab-sub]');
        var arrow   = tab.querySelector('[data-tab-arrow]');

        if (titleEl) titleEl.style.color = isActive ? 'rgb(240,249,255)' : 'rgb(148,163,184)';
        if (subEl)   subEl.style.color   = isActive ? 'rgb(125,211,252)' : 'rgb(100,116,139)';
        if (arrow)   arrow.style.opacity = isActive ? '1' : '0';
        if (arrow)   arrow.style.color   = isActive ? 'rgb(56,189,248)' : '';
      });

      panels.forEach(function (panel) {
        panel.classList.toggle('hidden', panel.dataset.hubPanel !== name);
      });

      // When activating Calendly tab, trigger preload immediately
      if (name === 'calendly') {
        var preloaders = window._latamCalendlyPreloaders || [];
        preloaders.forEach(function (fn) { try { fn(); } catch (e) {} });
      }
    }

    activate('form');

    tabs.forEach(function (tab) {
      tab.addEventListener('click', function () {
        activate(tab.dataset.hubTab);
      });
    });

    // Expose a stable JS API so external CTAs can switch tabs
    // Accumulate into array to support multiple hubs on one page
    if (!window.latamHub) window.latamHub = {};
    var existingActivateCalendly = window.latamHub.activateCalendly;
    var existingActivateForm     = window.latamHub.activateForm;

    window.latamHub.activateCalendly = function () {
      if (existingActivateCalendly) existingActivateCalendly();
      activate('calendly');
    };
    window.latamHub.activateForm = function () {
      if (existingActivateForm) existingActivateForm();
      activate('form');
      // Focus first visible form field for UX
      setTimeout(function () {
        var panel = hub.querySelector('[data-hub-panel="form"]');
        if (panel) {
          var first = panel.querySelector('input:not([type="hidden"]):not([aria-hidden]),textarea,select');
          if (first) first.focus({ preventScroll: true });
        }
      }, 100);
    };

    // Pre-warm Calendly when contact hub enters the viewport (400px ahead)
    if ('IntersectionObserver' in window) {
      var preloadObs = new IntersectionObserver(
        function (entries) {
          if (entries[0].isIntersecting) {
            preloadObs.disconnect();
            var preloaders = window._latamCalendlyPreloaders || [];
            preloaders.forEach(function (fn) { try { fn(); } catch (e) {} });
          }
        },
        { rootMargin: '400px' }
      );
      preloadObs.observe(hub);
    }
  });
})();
</script>
