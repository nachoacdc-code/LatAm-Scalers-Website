---
import { BOOKING_URL, isExternalUrl } from '../lib/cta';

const pathname = Astro.url.pathname;

const isSolutions =
	pathname.startsWith('/solutions/') ||
	pathname.startsWith('/aec/') ||
	pathname.startsWith('/design/') ||
	pathname.startsWith('/marketing/');
const isRoles = pathname.startsWith('/roles/');
const isHowItWorks = pathname.startsWith('/how-it-works');

const bookingUrl = BOOKING_URL;
const bookingExternal = isExternalUrl(bookingUrl);

const linkBase =
	'transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950';
const linkDesktopBase = `rounded-md px-1 py-2 ${linkBase}`;
const linkMobileBase = `rounded-xl px-3 py-3 ${linkBase}`;
const linkActive = 'text-white font-semibold';

const solutions = [
	{
		label: 'AEC Talent',
		description: 'BIM coordination, Revit modeling, CAD drafting & engineering support',
		href: '/solutions/aec-talent/',
		accent: 'text-sky-300',
	},
	{
		label: 'Creative & Design',
		description: 'Dedicated designers or PM-led managed creative teams',
		href: '/solutions/creatives-design/',
		accent: 'text-violet-400',
	},
	{
		label: 'Marketing Talent',
		description: 'SEO, paid media, lifecycle, content & marketing ops specialists',
		href: '/solutions/marketing-talent/',
		accent: 'text-emerald-400',
	},
];
---

<header class="sticky top-0 z-50 border-b border-slate-800 bg-slate-950/90 backdrop-blur">
	<div class="mx-auto flex max-w-6xl items-center justify-between gap-4 px-6 py-4">
		<!-- Logo (= home) -->
		<a
			href="/"
			class="text-sm font-semibold tracking-tight text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
			aria-label="LatAm Scalers — home"
		>
			LatAm Scalers
		</a>

		<!-- Desktop nav -->
		<nav class="hidden items-center gap-6 text-sm text-slate-200 md:flex" aria-label="Primary">

			<!-- Solutions mega menu -->
			<details class="group relative" data-nav-dropdown="solutions">
				<summary
					class={`flex cursor-pointer list-none items-center gap-1.5 ${linkDesktopBase} ${isSolutions ? linkActive : ''}`}
					aria-haspopup="menu"
					aria-expanded="false"
					aria-controls="solutions-menu"
				>
					<span>Solutions</span>
					<svg class="h-3.5 w-3.5 text-slate-400 transition group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
						<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z" clip-rule="evenodd" />
					</svg>
				</summary>

				<div
					id="solutions-menu"
					role="menu"
					aria-label="Solutions"
					class="absolute left-0 mt-2 w-80 rounded-2xl border border-slate-700/60 bg-slate-900/95 p-2 shadow-2xl shadow-black/40 ring-1 ring-slate-700/40 backdrop-blur-xl"
				>
					{solutions.map((item) => {
						const active = pathname.startsWith(item.href);
						return (
							<a
								role="menuitem"
								href={item.href}
								class={`block rounded-xl px-3 py-3 transition hover:bg-slate-800/70 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 ${active ? 'bg-slate-800/70' : ''}`}
								aria-current={active ? 'page' : undefined}
							>
								<p class={`text-sm font-semibold ${active ? 'text-white' : item.accent}`}>{item.label}</p>
								<p class="mt-0.5 text-xs leading-relaxed text-slate-400">{item.description}</p>
							</a>
						);
					})}

					<!-- Divider -->
					<div class="my-1 border-t border-slate-700/60" />

					<a
						role="menuitem"
						href="/how-it-works/"
						class={`block rounded-xl px-3 py-2.5 text-sm transition hover:bg-slate-800/70 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 ${isHowItWorks ? 'bg-slate-800/70 text-white font-semibold' : 'text-slate-300'}`}
					>
						How It Works
					</a>
					<a
						role="menuitem"
						href="/how-pricing-works/"
						class="block rounded-xl px-3 py-2.5 text-sm text-slate-300 transition hover:bg-slate-800/70 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
					>
						How Pricing Works
					</a>
				</div>
			</details>

			<!-- Roles — direct link -->
			<a
				href="/roles/"
				class={`${linkDesktopBase} ${isRoles ? linkActive : ''}`}
				aria-current={isRoles ? 'page' : undefined}
			>
				Roles
			</a>

			<!-- How It Works — direct link -->
			<a
				href="/how-it-works/"
				class={`${linkDesktopBase} ${isHowItWorks ? linkActive : ''}`}
				aria-current={isHowItWorks ? 'page' : undefined}
			>
				How It Works
			</a>

			<!-- CTA -->
			<a
				href={bookingUrl}
				{...(bookingExternal ? { target: '_blank', rel: 'noreferrer' } : {})}
				class="ml-1 inline-flex items-center justify-center rounded bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
				data-book-call
			>
				Get Started
			</a>
		</nav>

		<!-- Mobile: Get Started always visible + hamburger -->
		<div class="flex items-center gap-2 md:hidden">
			<a
				href={bookingUrl}
				{...(bookingExternal ? { target: '_blank', rel: 'noreferrer' } : {})}
				class="inline-flex items-center justify-center rounded bg-sky-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-sky-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
				data-book-call
			>
				Get Started
			</a>
			<button
				type="button"
				class="inline-flex items-center justify-center rounded-lg border border-slate-800 bg-slate-900/50 p-2 text-slate-100 transition hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
				aria-label="Open menu"
				aria-expanded="false"
				aria-controls="mobile-menu"
				data-nav-mobile-toggle
			>
				<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-icon-menu>
					<path fill-rule="evenodd" d="M2 4.75A.75.75 0 0 1 2.75 4h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75Zm0 5.25a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 10Zm0 5.25a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 15.25Z" clip-rule="evenodd" />
				</svg>
				<svg class="hidden h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-icon-close>
					<path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
				</svg>
			</button>
		</div>
	</div>

	<!-- Mobile menu (full-width overlay) -->
	<div id="mobile-menu" class="hidden border-t border-slate-800 bg-slate-950/98 md:hidden" data-nav-mobile-menu>
		<nav class="mx-auto max-w-6xl px-6 py-5" aria-label="Mobile primary">
			<div class="flex flex-col gap-2 text-sm text-slate-200">

				<!-- Solutions — category cards -->
				<p class="px-3 pt-1 text-xs font-semibold uppercase tracking-wide text-slate-500">Solutions</p>
				<div class="grid gap-2">
					{solutions.map((item) => {
						const active = pathname.startsWith(item.href);
						return (
							<a
								href={item.href}
								class={`flex min-h-[48px] items-start gap-3 rounded-xl border border-slate-800 px-4 py-3 transition hover:bg-slate-900 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300 ${active ? 'bg-slate-900 text-white' : ''}`}
								aria-current={active ? 'page' : undefined}
							>
								<div>
									<p class={`text-sm font-semibold ${active ? 'text-white' : item.accent}`}>{item.label}</p>
									<p class="mt-0.5 text-xs text-slate-400">{item.description}</p>
								</div>
							</a>
						);
					})}
				</div>

				<div class="my-1 border-t border-slate-800" />

				<!-- Roles -->
				<a
					href="/roles/"
					class={`min-h-[48px] flex items-center ${linkMobileBase} transition hover:bg-slate-900 hover:text-white ${isRoles ? linkActive : ''}`}
					aria-current={isRoles ? 'page' : undefined}
				>
					Roles
				</a>

				<!-- How It Works -->
				<a
					href="/how-it-works/"
					class={`min-h-[48px] flex items-center ${linkMobileBase} transition hover:bg-slate-900 hover:text-white ${isHowItWorks ? linkActive : ''}`}
					aria-current={isHowItWorks ? 'page' : undefined}
				>
					How It Works
				</a>

				<!-- How Pricing Works -->
				<a
					href="/how-pricing-works/"
					class="min-h-[48px] flex items-center rounded-xl px-3 py-3 text-slate-300 transition hover:bg-slate-900 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
				>
					How Pricing Works
				</a>
			</div>
		</nav>
	</div>

	<script is:inline>
		(() => {
  const header = document.currentScript?.closest('header');
  if (!header) return;

  const mobileToggle = header.querySelector('[data-nav-mobile-toggle]');
  const mobileMenu = header.querySelector('[data-nav-mobile-menu]');
  const iconMenu = header.querySelector('[data-icon-menu]');
  const iconClose = header.querySelector('[data-icon-close]');

  function setMobile(open) {
    if (!mobileToggle || !mobileMenu) return;
    mobileMenu.classList.toggle('hidden', !open);
    mobileToggle.setAttribute('aria-expanded', String(open));
    mobileToggle.setAttribute('aria-label', open ? 'Close menu' : 'Open menu');
    if (iconMenu) iconMenu.classList.toggle('hidden', open);
    if (iconClose) iconClose.classList.toggle('hidden', !open);
  }

  mobileToggle?.addEventListener('click', () => {
    const open = mobileToggle.getAttribute('aria-expanded') !== 'true';
    setMobile(open);
    if (open) {
      const first = mobileMenu?.querySelector('a, button, [tabindex]:not([tabindex="-1"])');
      first?.focus?.();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (mobileToggle?.getAttribute('aria-expanded') === 'true') {
      setMobile(false);
      mobileToggle?.focus?.();
    }
    header.querySelectorAll('details[open]').forEach((d) => d.removeAttribute('open'));
  });

  document.addEventListener('click', (e) => {
    if (!header.contains(e.target)) {
      setMobile(false);
      header.querySelectorAll('details[open]').forEach((d) => d.removeAttribute('open'));
    }
  });

  const desktopDropdowns = header.querySelectorAll('nav[aria-label="Primary"] details[data-nav-dropdown]');

  desktopDropdowns.forEach((details) => {
    const summary = details.querySelector('summary');
    summary?.setAttribute('aria-expanded', String(details.hasAttribute('open')));

    summary?.addEventListener('pointerdown', () => {
      desktopDropdowns.forEach((other) => {
        if (other !== details && other.hasAttribute('open')) {
          other.removeAttribute('open');
          other.querySelector('summary')?.setAttribute('aria-expanded', 'false');
        }
      });
    });

    details.addEventListener('toggle', () => {
      summary?.setAttribute('aria-expanded', String(details.hasAttribute('open')));
    });
  });

  const canHover = window.matchMedia?.('(hover: hover) and (pointer: fine)')?.matches;
  if (canHover) {
    desktopDropdowns.forEach((details) => {
      let closeTimer = null;

      details.addEventListener('mouseenter', () => {
        if (closeTimer) { clearTimeout(closeTimer); closeTimer = null; }
        desktopDropdowns.forEach((other) => {
          if (other !== details && other.hasAttribute('open')) {
            other.removeAttribute('open');
            other.querySelector('summary')?.setAttribute('aria-expanded', 'false');
          }
        });
        if (!details.hasAttribute('open')) {
          details.setAttribute('open', '');
          details.querySelector('summary')?.setAttribute('aria-expanded', 'true');
        }
      });

      details.addEventListener('mouseleave', () => {
        if (closeTimer) clearTimeout(closeTimer);
        closeTimer = setTimeout(() => {
          details.removeAttribute('open');
          details.querySelector('summary')?.setAttribute('aria-expanded', 'false');
        }, 150);
      });
    });
  }
})();
	</script>
</header>
